<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circuit Timer</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  text-align: center;
  color: white;
  transition: background-color 0.4s ease;
}

.container {
  padding: 20px;
  max-width: 500px;
  margin: auto;
}

input, textarea {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  font-size: 16px;
}

button {
  padding: 12px 20px;
  margin: 6px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
}

#timer {
  font-size: 80px;
  margin: 20px 0;
}

.exercise { background-color: #1faa00; }
.rest { background-color: #d90000; }
.neutral { background-color: #111; }

.hidden { display: none; }

iframe {
  margin-top: 15px;
  border-radius: 12px;
}
</style>
</head>

<body class="neutral">

<div class="container">

<h1>ðŸ”¥ Circuit Timer</h1>

<div id="setup">

<input type="number" id="exercises" placeholder="Number of Exercises">
<input type="number" id="rounds" placeholder="Number of Rounds">
<input type="number" id="exerciseTime" placeholder="Exercise Seconds">
<input type="number" id="restTime" placeholder="Rest Seconds">

<p>Exercise Names (one per line)</p>
<textarea id="exerciseNames" rows="4"></textarea>

<button onclick="startTimer()">Start Workout</button>

</div>

<div id="workout" class="hidden">

<h2 id="status">EXERCISE</h2>
<h3 id="exerciseName"></h3>
<div id="timer">0</div>
<p id="info"></p>

<button onclick="pauseResume()" id="pauseBtn">Pause</button>
<button onclick="resetTimer()">End Workout</button>

</div>

<h3>ðŸŽµ Spotify Playlist</h3>
<input type="text" id="spotifyUrl" placeholder="Paste Spotify playlist URL">
<button onclick="loadSpotify()">Load</button>
<div id="spotifyPlayer"></div>

</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

let interval;
let paused = false;

let totalExercises, totalRounds, exerciseDuration, restDuration;
let exerciseList = [];

let currentRound = 1;
let currentExercise = 0;
let isExercisePhase = true;
let timeRemaining = 0;

function beep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.frequency.value = 900;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.2);
}

function startTimer() {
  totalExercises = +document.getElementById("exercises").value;
  totalRounds = +document.getElementById("rounds").value;
  exerciseDuration = +document.getElementById("exerciseTime").value;
  restDuration = +document.getElementById("restTime").value;

  exerciseList = document.getElementById("exerciseNames")
    .value.split("\n")
    .filter(x => x.trim() !== "");

  if (exerciseList.length !== totalExercises) {
    alert("Exercise count must match names.");
    return;
  }

  document.getElementById("setup").classList.add("hidden");
  document.getElementById("workout").classList.remove("hidden");

  currentRound = 1;
  currentExercise = 0;
  isExercisePhase = true;
  timeRemaining = exerciseDuration;

  runTimer();
}

function runTimer() {
  updateDisplay();

  interval = setInterval(() => {

    if (paused) return;

    timeRemaining--;
    updateDisplay();

    if (timeRemaining <= 0) {
      clearInterval(interval);
      beep();

      if (isExercisePhase) {
        if (currentExercise === totalExercises - 1) {
          if (currentRound < totalRounds) {
            currentRound++;
            currentExercise = 0;
            timeRemaining = exerciseDuration;
          } else {
            finishWorkout();
            return;
          }
        } else {
          isExercisePhase = false;
          timeRemaining = restDuration;
        }
      } else {
        isExercisePhase = true;
        currentExercise++;
        timeRemaining = exerciseDuration;
      }

      runTimer();
    }

  }, 1000);
}

function updateDisplay() {
  document.getElementById("timer").innerText = timeRemaining;
  document.getElementById("status").innerText = isExercisePhase ? "EXERCISE" : "REST";
  document.getElementById("exerciseName").innerText =
    isExercisePhase ? exerciseList[currentExercise] : "Rest";
  document.getElementById("info").innerText =
    "Round " + currentRound + " of " + totalRounds;

  document.body.className = isExercisePhase ? "exercise" : "rest";
}

function pauseResume() {
  paused = !paused;
  document.getElementById("pauseBtn").innerText = paused ? "Resume" : "Pause";
}

function resetTimer() {
  clearInterval(interval);
  paused = false;
  document.body.className = "neutral";
  document.getElementById("workout").classList.add("hidden");
  document.getElementById("setup").classList.remove("hidden");
}

function finishWorkout() {
  alert("Workout Complete ðŸ’ª");
  resetTimer();
}

function loadSpotify() {
  const url = document.getElementById("spotifyUrl").value;
  const embedUrl = url.replace("playlist/", "embed/playlist/");
  document.getElementById("spotifyPlayer").innerHTML =
    `<iframe src="${embedUrl}" width="100%" height="152"
     allow="autoplay; encrypted-media"></iframe>`;
}
</script>

</body>
</html>
